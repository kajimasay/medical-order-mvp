<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Cell Vision Global</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .order-card {
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">æ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="text-gray-600">Cell Vision Global Limited - åŒ»ç™‚ç”¨ç™ºæ³¨ç®¡ç†</p>
            <div class="mt-4 flex gap-4">
                <button onclick="loadOrders()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    ğŸ”„ æ›´æ–°
                </button>
                <span id="orderCount" class="bg-green-100 text-green-800 px-3 py-2 rounded"></span>
                <span id="lastUpdate" class="text-gray-500 text-sm"></span>
            </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">ç·æ³¨æ–‡æ•°</h3>
                <div id="totalOrders" class="text-3xl font-bold text-blue-600">-</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">ä»Šæ—¥ã®æ³¨æ–‡</h3>
                <div id="todayOrders" class="text-3xl font-bold text-green-600">-</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">äººæ°—å•†å“</h3>
                <div id="popularProduct" class="text-lg font-medium text-purple-600">-</div>
            </div>
        </div>

        <!-- æ³¨æ–‡ä¸€è¦§ -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold text-gray-800">æ³¨æ–‡ä¸€è¦§</h2>
            </div>
            <div id="ordersContainer" class="p-6">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-4 text-gray-600">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ³¨æ–‡è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">æ³¨æ–‡è©³ç´°</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        âœ•
                    </button>
                </div>
            </div>
            <div id="orderDetails" class="p-6">
                <!-- è©³ç´°å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        let ordersData = [];

        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                ordersData = await response.json();
                displayOrders();
                updateStats();
                document.getElementById('lastUpdate').textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString('ja-JP')}`;
            } catch (error) {
                console.error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                document.getElementById('ordersContainer').innerHTML = 
                    '<div class="text-center py-8 text-red-600">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // æ³¨æ–‡ä¸€è¦§ã‚’è¡¨ç¤º
        function displayOrders() {
            const container = document.getElementById('ordersContainer');
            
            if (ordersData.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const ordersHtml = ordersData.map(order => `
                <div class="order-card bg-gray-50 rounded-lg p-4 mb-4 cursor-pointer border border-gray-200" 
                     onclick="showOrderDetails(${order.id})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">
                                    ID: ${order.id}
                                </span>
                                <span class="text-lg font-semibold text-gray-800">${order.full_name}</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-2 text-sm text-gray-600">
                                <div>ğŸ“¦ ${getProductName(order.product)} Ã— ${order.quantity}</div>
                                <div>ğŸ¢ ${order.company_name || 'å€‹äºº'}</div>
                                <div>ğŸ“ ${order.contact_name}</div>
                                <div>ğŸ“… ${new Date(order.created_at).toLocaleString('ja-JP')}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                å—ä»˜æ¸ˆã¿
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = ordersHtml;
        }

        // å•†å“åã‚’å–å¾—
        function getProductName(productId) {
            const products = {
                'eye-booster': 'SBC Eye Booster (è©¦è–¬)',
                'exosome-kit': 'Exosome Assay Kit',
                'cm-vial': 'hSC-CM Vial'
            };
            return products[productId] || productId;
        }

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStats() {
            const total = ordersData.length;
            const today = new Date().toDateString();
            const todayCount = ordersData.filter(order => 
                new Date(order.created_at).toDateString() === today
            ).length;

            // äººæ°—å•†å“ã‚’è¨ˆç®—
            const productCount = {};
            ordersData.forEach(order => {
                productCount[order.product] = (productCount[order.product] || 0) + order.quantity;
            });
            const popularProduct = Object.keys(productCount).reduce((a, b) => 
                productCount[a] > productCount[b] ? a : b, 'ãªã—'
            );

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('todayOrders').textContent = todayCount;
            document.getElementById('popularProduct').textContent = getProductName(popularProduct);
            document.getElementById('orderCount').textContent = `${total}ä»¶ã®æ³¨æ–‡`;
        }

        // æ³¨æ–‡è©³ç´°ã‚’è¡¨ç¤º
        function showOrderDetails(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;

            const details = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="font-semibold text-gray-700 mb-2">åŸºæœ¬æƒ…å ±</h4>
                            <div class="space-y-1 text-sm">
                                <div><span class="font-medium">æ³¨æ–‡ID:</span> ${order.id}</div>
                                <div><span class="font-medium">æ°å:</span> ${order.full_name}</div>
                                <div><span class="font-medium">å•†å“:</span> ${getProductName(order.product)}</div>
                                <div><span class="font-medium">æ•°é‡:</span> ${order.quantity}</div>
                                <div><span class="font-medium">æ³¨æ–‡æ—¥æ™‚:</span> ${new Date(order.created_at).toLocaleString('ja-JP')}</div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="font-semibold text-gray-700 mb-2">ä¼šç¤¾æƒ…å ±</h4>
                            <div class="space-y-1 text-sm">
                                <div><span class="font-medium">ä¼šç¤¾å:</span> ${order.company_name || 'ãªã—'}</div>
                                <div><span class="font-medium">ä¼šç¤¾é›»è©±:</span> ${order.company_phone || 'ãªã—'}</div>
                                <div><span class="font-medium">ä¼šç¤¾ä½æ‰€:</span> ${order.company_address || 'ãªã—'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded">
                        <h4 class="font-semibold text-gray-700 mb-2">å€‹äººæƒ…å ±</h4>
                        <div class="space-y-1 text-sm">
                            <div><span class="font-medium">è‡ªå®…ä½æ‰€:</span> ${order.home_address || 'ãªã—'}</div>
                            <div><span class="font-medium">è‡ªå®…é›»è©±:</span> ${order.home_phone || 'ãªã—'}</div>
                        </div>
                    </div>
                    ${order.license_path ? `
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="font-semibold text-gray-700 mb-2">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</h4>
                            <a href="${order.license_path}" target="_blank" 
                               class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition inline-block">
                                ğŸ“„ åŒ»å¸«å…è¨±çŠ¶ã‚’è¡¨ç¤º
                            </a>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('orderDetails').innerHTML = details;
            document.getElementById('orderModal').classList.remove('hidden');
            document.getElementById('orderModal').classList.add('flex');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('orderModal').classList.add('hidden');
            document.getElementById('orderModal').classList.remove('flex');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', loadOrders);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('orderModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>